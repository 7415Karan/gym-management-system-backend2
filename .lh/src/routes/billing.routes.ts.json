{
    "sourceFile": "src/routes/billing.routes.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 13,
            "patches": [
                {
                    "date": 1752358300670,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752359693987,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,5 @@\n+//src/routes/billing.routes.ts\r\n import express from 'express';\r\n import { PrismaClient } from '@prisma/client';\r\n import { Request, Response } from 'express';\r\n \r\n@@ -9,19 +10,22 @@\n   try {\r\n     const { memberId } = req.params;\r\n     const { cardNumber, expiry, cvc } = req.body;\r\n \r\n-    // ðŸ”§ fake parsing for local storage (replace with Stripe integration later)\r\n     const last4 = cardNumber.slice(-4);\r\n-    const [expMonth, expYear] = expiry.split('/');\r\n+    const [expMonthStr, expYearStr] = expiry.split('/');\r\n \r\n+    const brand = 'visa'; // placeholder â€” you'd detect brand in real Stripe integration\r\n+    const stripePaymentMethodId = `fake_${Math.random().toString(36).substring(2, 10)}`; // mock ID\r\n+\r\n     const method = await prisma.paymentMethod.create({\r\n       data: {\r\n         memberId,\r\n-        cardBrand: 'visa',\r\n+        stripePaymentMethodId,\r\n+        cardBrand: brand,\r\n         last4,\r\n-        expMonth: parseInt(expMonth),\r\n-        expYear: parseInt(`20${expYear}`),\r\n+        expMonth: parseInt(expMonthStr),\r\n+        expYear: parseInt('20' + expYearStr), // e.g., 25 -> 2025\r\n       },\r\n     });\r\n \r\n     res.status(201).json(method);\r\n"
                },
                {
                    "date": 1752360136398,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,4 +33,6 @@\n     console.error('Save Payment Method Error:', err);\r\n     res.status(500).json({ error: 'Failed to save payment method' });\r\n   }\r\n });\r\n+\r\n+export default router; \r\n"
                },
                {
                    "date": 1752360435084,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -34,5 +34,33 @@\n     res.status(500).json({ error: 'Failed to save payment method' });\r\n   }\r\n });\r\n \r\n+router.get('/:memberId', async (req: Request, res: Response) => {\r\n+  const { memberId } = req.params;\r\n+\r\n+  try {\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id: memberId },\r\n+      include: {\r\n+        paymentMethod: true,\r\n+        // If you add invoice model later, include it here too\r\n+        // invoices: true,\r\n+      },\r\n+    });\r\n+\r\n+    if (!member) {\r\n+      return res.status(404).json({ error: 'Member not found' });\r\n+    }\r\n+\r\n+    res.json({\r\n+      paymentMethod: member.paymentMethod,\r\n+      invoices: [], // Temporary â€” until invoices are added\r\n+    });\r\n+  } catch (err) {\r\n+    console.error('Fetch billing error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch billing data' });\r\n+  }\r\n+});\r\n+\r\n+\r\n export default router; \r\n"
                },
                {
                    "date": 1752373112927,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -62,5 +62,22 @@\n   }\r\n });\r\n \r\n \r\n+router.get('/:memberId', async (req, res) => {\r\n+  const { memberId } = req.params;\r\n+\r\n+  try {\r\n+    const [paymentMethod, invoices] = await Promise.all([\r\n+      prisma.paymentMethod.findUnique({ where: { memberId } }),\r\n+      prisma.invoice.findMany({ where: { memberId }, orderBy: { issuedAt: 'desc' } }),\r\n+    ]);\r\n+\r\n+    res.json({ paymentMethod, invoices });\r\n+  } catch (err) {\r\n+    console.error('Billing fetch error:', err);\r\n+    res.status(500).json({ error: 'Failed to load billing data' });\r\n+  }\r\n+});\r\n+\r\n+\r\n export default router; \r\n"
                },
                {
                    "date": 1752373264608,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -63,21 +63,26 @@\n });\r\n \r\n \r\n router.get('/:memberId', async (req, res) => {\r\n-  const { memberId } = req.params;\r\n-\r\n   try {\r\n-    const [paymentMethod, invoices] = await Promise.all([\r\n-      prisma.paymentMethod.findUnique({ where: { memberId } }),\r\n-      prisma.invoice.findMany({ where: { memberId }, orderBy: { issuedAt: 'desc' } }),\r\n-    ]);\r\n+    const { memberId } = req.params;\r\n \r\n+    const paymentMethod = await prisma.paymentMethod.findUnique({\r\n+      where: { memberId },\r\n+    });\r\n+\r\n+    const invoices = await prisma.invoice.findMany({\r\n+      where: { memberId },\r\n+      orderBy: { issuedAt: 'desc' },\r\n+    });\r\n+\r\n     res.json({ paymentMethod, invoices });\r\n   } catch (err) {\r\n-    console.error('Billing fetch error:', err);\r\n-    res.status(500).json({ error: 'Failed to load billing data' });\r\n+    console.error('Fetch billing error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch billing data' });\r\n   }\r\n });\r\n \r\n \r\n+\r\n export default router; \r\n"
                },
                {
                    "date": 1752373378556,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,106 @@\n+//src/routes/billing.routes.ts\r\n+import express from 'express';\r\n+import { PrismaClient } from '@prisma/client';\r\n+import { Request, Response } from 'express';\r\n+\r\n+const router = express.Router();\r\n+const prisma = new PrismaClient();\r\n+\r\n+router.post('/:memberId/payment-method', async (req, res) => {\r\n+  try {\r\n+    const { memberId } = req.params;\r\n+    const { cardNumber, expiry, cvc } = req.body;\r\n+\r\n+    const last4 = cardNumber.slice(-4);\r\n+    const [expMonthStr, expYearStr] = expiry.split('/');\r\n+\r\n+    const brand = 'visa'; // placeholder â€” you'd detect brand in real Stripe integration\r\n+    const stripePaymentMethodId = `fake_${Math.random().toString(36).substring(2, 10)}`; // mock ID\r\n+\r\n+    const method = await prisma.paymentMethod.create({\r\n+      data: {\r\n+        memberId,\r\n+        stripePaymentMethodId,\r\n+        cardBrand: brand,\r\n+        last4,\r\n+        expMonth: parseInt(expMonthStr),\r\n+        expYear: parseInt('20' + expYearStr), // e.g., 25 -> 2025\r\n+      },\r\n+    });\r\n+\r\n+    res.status(201).json(method);\r\n+  } catch (err) {\r\n+    console.error('Save Payment Method Error:', err);\r\n+    res.status(500).json({ error: 'Failed to save payment method' });\r\n+  }\r\n+});\r\n+\r\n+router.get('/:memberId', async (req: Request, res: Response) => {\r\n+  const { memberId } = req.params;\r\n+\r\n+  try {\r\n+    const member = await prisma.member.findUnique({\r\n+      where: { id: memberId },\r\n+      include: {\r\n+        paymentMethod: true,\r\n+        // If you add invoice model later, include it here too\r\n+        // invoices: true,\r\n+      },\r\n+    });\r\n+\r\n+    if (!member) {\r\n+      return res.status(404).json({ error: 'Member not found' });\r\n+    }\r\n+\r\n+    res.json({\r\n+      paymentMethod: member.paymentMethod,\r\n+      invoices: [], // Temporary â€” until invoices are added\r\n+    });\r\n+  } catch (err) {\r\n+    console.error('Fetch billing error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch billing data' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+router.get('/:memberId', async (req, res) => {\r\n+  try {\r\n+    const { memberId } = req.params;\r\n+\r\n+    const paymentMethod = await prisma.paymentMethod.findUnique({\r\n+      where: { memberId },\r\n+    });\r\n+\r\n+    const invoices = await prisma.invoice.findMany({\r\n+      where: { memberId },\r\n+      orderBy: { issuedAt: 'desc' },\r\n+    });\r\n+\r\n+    res.json({ paymentMethod, invoices });\r\n+  } catch (err) {\r\n+    console.error('Fetch billing error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch billing data' });\r\n+  }\r\n+});\r\n+\r\n+// PATCH /api/billing/invoices/:id/pay\r\n+router.patch('/invoices/:id/pay', async (req, res) => {\r\n+  try {\r\n+    const { id } = req.params;\r\n+\r\n+    const invoice = await prisma.invoice.update({\r\n+      where: { id },\r\n+      data: { status: 'paid' },\r\n+    });\r\n+\r\n+    res.json(invoice);\r\n+  } catch (err) {\r\n+    console.error('Invoice payment error:', err);\r\n+    res.status(500).json({ error: 'Failed to mark invoice as paid' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n+\r\n+export default router; \r\n"
                },
                {
                    "date": 1752375680523,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -34,34 +34,34 @@\n     res.status(500).json({ error: 'Failed to save payment method' });\r\n   }\r\n });\r\n \r\n-router.get('/:memberId', async (req: Request, res: Response) => {\r\n-  const { memberId } = req.params;\r\n+// router.get('/:memberId', async (req: Request, res: Response) => {\r\n+//   const { memberId } = req.params;\r\n \r\n-  try {\r\n-    const member = await prisma.member.findUnique({\r\n-      where: { id: memberId },\r\n-      include: {\r\n-        paymentMethod: true,\r\n-        // If you add invoice model later, include it here too\r\n-        // invoices: true,\r\n-      },\r\n-    });\r\n+//   try {\r\n+//     const member = await prisma.member.findUnique({\r\n+//       where: { id: memberId },\r\n+//       include: {\r\n+//         paymentMethod: true,\r\n+//         // If you add invoice model later, include it here too\r\n+//         // invoices: true,\r\n+//       },\r\n+//     });\r\n \r\n-    if (!member) {\r\n-      return res.status(404).json({ error: 'Member not found' });\r\n-    }\r\n+//     if (!member) {\r\n+//       return res.status(404).json({ error: 'Member not found' });\r\n+//     }\r\n \r\n-    res.json({\r\n-      paymentMethod: member.paymentMethod,\r\n-      invoices: [], // Temporary â€” until invoices are added\r\n-    });\r\n-  } catch (err) {\r\n-    console.error('Fetch billing error:', err);\r\n-    res.status(500).json({ error: 'Failed to fetch billing data' });\r\n-  }\r\n-});\r\n+//     res.json({\r\n+//       paymentMethod: member.paymentMethod,\r\n+//       invoices: [], // Temporary â€” until invoices are added\r\n+//     });\r\n+//   } catch (err) {\r\n+//     console.error('Fetch billing error:', err);\r\n+//     res.status(500).json({ error: 'Failed to fetch billing data' });\r\n+//   }\r\n+// });\r\n \r\n \r\n router.get('/:memberId', async (req, res) => {\r\n   try {\r\n@@ -103,92 +103,4 @@\n \r\n \r\n \r\n export default router; \r\n-//src/routes/billing.routes.ts\r\n-import express from 'express';\r\n-import { PrismaClient } from '@prisma/client';\r\n-import { Request, Response } from 'express';\r\n-\r\n-const router = express.Router();\r\n-const prisma = new PrismaClient();\r\n-\r\n-router.post('/:memberId/payment-method', async (req, res) => {\r\n-  try {\r\n-    const { memberId } = req.params;\r\n-    const { cardNumber, expiry, cvc } = req.body;\r\n-\r\n-    const last4 = cardNumber.slice(-4);\r\n-    const [expMonthStr, expYearStr] = expiry.split('/');\r\n-\r\n-    const brand = 'visa'; // placeholder â€” you'd detect brand in real Stripe integration\r\n-    const stripePaymentMethodId = `fake_${Math.random().toString(36).substring(2, 10)}`; // mock ID\r\n-\r\n-    const method = await prisma.paymentMethod.create({\r\n-      data: {\r\n-        memberId,\r\n-        stripePaymentMethodId,\r\n-        cardBrand: brand,\r\n-        last4,\r\n-        expMonth: parseInt(expMonthStr),\r\n-        expYear: parseInt('20' + expYearStr), // e.g., 25 -> 2025\r\n-      },\r\n-    });\r\n-\r\n-    res.status(201).json(method);\r\n-  } catch (err) {\r\n-    console.error('Save Payment Method Error:', err);\r\n-    res.status(500).json({ error: 'Failed to save payment method' });\r\n-  }\r\n-});\r\n-\r\n-router.get('/:memberId', async (req: Request, res: Response) => {\r\n-  const { memberId } = req.params;\r\n-\r\n-  try {\r\n-    const member = await prisma.member.findUnique({\r\n-      where: { id: memberId },\r\n-      include: {\r\n-        paymentMethod: true,\r\n-        // If you add invoice model later, include it here too\r\n-        // invoices: true,\r\n-      },\r\n-    });\r\n-\r\n-    if (!member) {\r\n-      return res.status(404).json({ error: 'Member not found' });\r\n-    }\r\n-\r\n-    res.json({\r\n-      paymentMethod: member.paymentMethod,\r\n-      invoices: [], // Temporary â€” until invoices are added\r\n-    });\r\n-  } catch (err) {\r\n-    console.error('Fetch billing error:', err);\r\n-    res.status(500).json({ error: 'Failed to fetch billing data' });\r\n-  }\r\n-});\r\n-\r\n-\r\n-router.get('/:memberId', async (req, res) => {\r\n-  try {\r\n-    const { memberId } = req.params;\r\n-\r\n-    const paymentMethod = await prisma.paymentMethod.findUnique({\r\n-      where: { memberId },\r\n-    });\r\n-\r\n-    const invoices = await prisma.invoice.findMany({\r\n-      where: { memberId },\r\n-      orderBy: { issuedAt: 'desc' },\r\n-    });\r\n-\r\n-    res.json({ paymentMethod, invoices });\r\n-  } catch (err) {\r\n-    console.error('Fetch billing error:', err);\r\n-    res.status(500).json({ error: 'Failed to fetch billing data' });\r\n-  }\r\n-});\r\n-\r\n-\r\n-\r\n-export default router; \r\n"
                },
                {
                    "date": 1752508330574,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -100,7 +100,46 @@\n   }\r\n });\r\n \r\n \r\n+//to get all \r\n+router.get('/', async (req, res) => {\r\n+  const { clubId, startDate, endDate, type } = req.query;\r\n \r\n+  try {\r\n+    const invoices = await prisma.invoice.findMany({\r\n+      where: {\r\n+        clubId: String(clubId),\r\n+        issuedAt: {\r\n+          gte: startDate ? new Date(String(startDate)) : undefined,\r\n+          lte: endDate ? new Date(String(endDate)) : undefined,\r\n+        },\r\n+        ...(type && { member: { membershipType: String(type) } }),\r\n+      },\r\n+      include: {\r\n+        member: true,\r\n+      },\r\n+      orderBy: { issuedAt: 'desc' },\r\n+    });\r\n \r\n+    const response = invoices.map(inv => ({\r\n+      id: inv.id,\r\n+      memberName: `${inv.member.firstName} ${inv.member.lastName}`,\r\n+      amount: inv.amount,\r\n+      status: inv.status,\r\n+      issuedAt: inv.issuedAt,\r\n+      dueDate: inv.dueDate,\r\n+    }));\r\n+\r\n+    res.json(response);\r\n+  } catch (err) {\r\n+    console.error('Error fetching billing data:', err);\r\n+    res.status(500).json({ error: 'Internal server error' });\r\n+  }\r\n+});\r\n+\r\n+export default router;\r\n+\r\n+\r\n+\r\n+\r\n export default router; \r\n"
                },
                {
                    "date": 1752508346165,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -141,5 +141,5 @@\n \r\n \r\n \r\n \r\n-export default router; \r\n+\r\n"
                },
                {
                    "date": 1752508739105,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,8 +104,10 @@\n //to get all \r\n router.get('/', async (req, res) => {\r\n   const { clubId, startDate, endDate, type } = req.query;\r\n \r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+\r\n   try {\r\n     const invoices = await prisma.invoice.findMany({\r\n       where: {\r\n         clubId: String(clubId),\r\n@@ -114,10 +116,12 @@\n           lte: endDate ? new Date(String(endDate)) : undefined,\r\n         },\r\n         ...(type && { member: { membershipType: String(type) } }),\r\n       },\r\n-      include: {\r\n-        member: true,\r\n+     include: {\r\n+        member: {\r\n+          select: { firstName: true, lastName: true },\r\n+        },\r\n       },\r\n       orderBy: { issuedAt: 'desc' },\r\n     });\r\n \r\n"
                },
                {
                    "date": 1752529950236,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -140,8 +140,49 @@\n     res.status(500).json({ error: 'Internal server error' });\r\n   }\r\n });\r\n \r\n+router.get('/summary', async (req, res) => {\r\n+  const { clubId, startDate, endDate } = req.query;\r\n+\r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+\r\n+  try {\r\n+    const filters = {\r\n+      clubId: String(clubId),\r\n+      issuedAt: {\r\n+        gte: startDate ? new Date(String(startDate)) : undefined,\r\n+        lte: endDate ? new Date(String(endDate)) : undefined,\r\n+      },\r\n+    };\r\n+\r\n+    const [totalRevenue, unpaidDues, activeMembers] = await Promise.all([\r\n+      prisma.invoice.aggregate({\r\n+        where: { ...filters, status: 'paid' },\r\n+        _sum: { amount: true },\r\n+      }),\r\n+      prisma.invoice.aggregate({\r\n+        where: { ...filters, status: { in: ['unpaid', 'overdue', 'failed'] } },\r\n+        _sum: { amount: true },\r\n+      }),\r\n+      prisma.member.count({\r\n+        where: { clubId: String(clubId), memberType: 'member' },\r\n+      }),\r\n+    ]);\r\n+\r\n+    res.json({\r\n+      totalRevenue: totalRevenue._sum.amount ?? 0,\r\n+      unpaidDues: unpaidDues._sum.amount ?? 0,\r\n+      activeMembers,\r\n+      attendanceRate: 78, // placeholder until real logic exists\r\n+    });\r\n+  } catch (err) {\r\n+    console.error('Summary error:', err);\r\n+    res.status(500).json({ error: 'Failed to calculate summary' });\r\n+  }\r\n+});\r\n+\r\n+\r\n export default router;\r\n \r\n \r\n \r\n"
                },
                {
                    "date": 1752530479949,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -180,9 +180,39 @@\n     res.status(500).json({ error: 'Failed to calculate summary' });\r\n   }\r\n });\r\n \r\n+// GET /api/billing/members?clubId=...&membershipType=...\r\n+router.get('/members', async (req, res) => {\r\n+  const { clubId, membershipType } = req.query;\r\n \r\n+  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+\r\n+  try {\r\n+    const members = await prisma.member.findMany({\r\n+      where: {\r\n+        clubId: String(clubId),\r\n+        ...(membershipType && { memberType: String(membershipType) }),\r\n+      },\r\n+      select: {\r\n+        id: true,\r\n+        firstName: true,\r\n+        lastName: true,\r\n+        memberType: true,\r\n+        createdAt: true,\r\n+      },\r\n+      orderBy: { createdAt: 'desc' },\r\n+    });\r\n+\r\n+    res.json(members);\r\n+  } catch (err) {\r\n+    console.error('Membership Report fetch error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch membership report' });\r\n+  }\r\n+});\r\n+\r\n+\r\n+\r\n export default router;\r\n \r\n \r\n \r\n"
                },
                {
                    "date": 1752530760661,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -180,39 +180,39 @@\n     res.status(500).json({ error: 'Failed to calculate summary' });\r\n   }\r\n });\r\n \r\n-// GET /api/billing/members?clubId=...&membershipType=...\r\n router.get('/members', async (req, res) => {\r\n   const { clubId, membershipType } = req.query;\r\n \r\n-  if (!clubId) return res.status(400).json({ error: 'Missing clubId' });\r\n+  if (!clubId) {\r\n+    return res.status(400).json({ error: 'clubId is required' });\r\n+  }\r\n \r\n   try {\r\n     const members = await prisma.member.findMany({\r\n       where: {\r\n         clubId: String(clubId),\r\n         ...(membershipType && { memberType: String(membershipType) }),\r\n       },\r\n-      select: {\r\n-        id: true,\r\n-        firstName: true,\r\n-        lastName: true,\r\n-        memberType: true,\r\n-        createdAt: true,\r\n-      },\r\n       orderBy: { createdAt: 'desc' },\r\n     });\r\n \r\n-    res.json(members);\r\n+    const response = members.map((m) => ({\r\n+      id: m.id,\r\n+      firstName: m.firstName,\r\n+      lastName: m.lastName,\r\n+      memberType: m.memberType,\r\n+      createdAt: m.createdAt,\r\n+    }));\r\n+\r\n+    res.json(response);\r\n   } catch (err) {\r\n-    console.error('Membership Report fetch error:', err);\r\n-    res.status(500).json({ error: 'Failed to fetch membership report' });\r\n+    console.error('Fetch members error:', err);\r\n+    res.status(500).json({ error: 'Failed to fetch members' });\r\n   }\r\n });\r\n \r\n-\r\n-\r\n export default router;\r\n \r\n \r\n \r\n"
                }
            ],
            "date": 1752358300670,
            "name": "Commit-0",
            "content": "import express from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { Request, Response } from 'express';\r\n\r\nconst router = express.Router();\r\nconst prisma = new PrismaClient();\r\n\r\nrouter.post('/:memberId/payment-method', async (req, res) => {\r\n  try {\r\n    const { memberId } = req.params;\r\n    const { cardNumber, expiry, cvc } = req.body;\r\n\r\n    // ðŸ”§ fake parsing for local storage (replace with Stripe integration later)\r\n    const last4 = cardNumber.slice(-4);\r\n    const [expMonth, expYear] = expiry.split('/');\r\n\r\n    const method = await prisma.paymentMethod.create({\r\n      data: {\r\n        memberId,\r\n        cardBrand: 'visa',\r\n        last4,\r\n        expMonth: parseInt(expMonth),\r\n        expYear: parseInt(`20${expYear}`),\r\n      },\r\n    });\r\n\r\n    res.status(201).json(method);\r\n  } catch (err) {\r\n    console.error('Save Payment Method Error:', err);\r\n    res.status(500).json({ error: 'Failed to save payment method' });\r\n  }\r\n});\r\n"
        }
    ]
}